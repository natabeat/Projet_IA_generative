{% extends "base.html" %}

{% block title %}Chat{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1 class="text-center text-white">Welcome on Chat GPT</h1>

    <div class="container mt-5">
        <h1 class="text-white">Chat Bot</h1>
        <div class="chat-box mt-3">
        </div>
        <div class="form-group mt-3">
            <textarea class="form-control" rows="3" placeholder="Type your message here" id="message-input" aria-label="Message Input"></textarea>
        </div>
        <button type="button" class="btn btn-primary" id="send-btn">Send</button>
    </div>
</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.16.0/umd/popper.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/highlight.js@10.7.2/lib/languages/python.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/a11y-dark.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>

<script>
  function highlightAll() {
    document.querySelectorAll("pre code").forEach(block => {
      hljs.highlightBlock(block);
    });
  }

  const chatBox = document.querySelector(".chat-box");
  const messageInput = document.querySelector("#message-input");
  const sendBtn = document.querySelector("#send-btn");

  function addMessage(message, isUserMessage) {
    const messageDiv = document.createElement("div");
    messageDiv.classList.add("mt-3", "p-3", "rounded");

    if (isUserMessage) {
      messageDiv.classList.add("user-message", "bg-primary", "text-white");
    } else {
      messageDiv.classList.add("bot-message", "bg-secondary", "text-white");
    }

    messageDiv.innerHTML = `<p>${message}</p>`;
    chatBox.appendChild(messageDiv);
    chatBox.scrollTop = chatBox.scrollHeight;
    highlightAll();
  }

  function sendMessage() {
    const message = messageInput.value.trim();
    if (message !== "") {
      addMessage(message, true);
      fetch("/api", {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ message })
      })
      .then(response => response.json())
      .then(data => {
        messageInput.value = "";
        const content = data.content;
        const hasCodeBlock = content.includes("```");
        const messageDiv = document.createElement("div");
        messageDiv.classList.add("mt-3", "p-3", "rounded", "bot-message", "bg-secondary", "text-white");
        if (hasCodeBlock) {
          const codeContent = content.replace(/```([\s\S]+?)```/g, '</p><pre><code>$1</code></pre><p>');
          messageDiv.innerHTML = `<p>${codeContent}</p>`;
        } else {
          messageDiv.innerHTML = `<p>${content}</p>`;
        }
        chatBox.appendChild(messageDiv);
        chatBox.scrollTop = chatBox.scrollHeight;
        highlightAll();
      })
      .catch(error => {
        console.error(error);
        alert('An error occurred. Please try again.');
      });
    }
  }

  sendBtn.addEventListener("click", sendMessage);
  messageInput.addEventListener("keydown", event => {
    if (event.keyCode === 13 && !event.shiftKey) {
      event.preventDefault();
      sendMessage();
    }
  });
</script>
{% endblock %}
